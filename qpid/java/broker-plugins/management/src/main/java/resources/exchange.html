<!DOCTYPE HTML>
<!--
 -
 - Licensed to the Apache Software Foundation (ASF) under one
 - or more contributor license agreements.  See the NOTICE file
 - distributed with this work for additional information
 - regarding copyright ownership.  The ASF licenses this file
 - to you under the Apache License, Version 2.0 (the
 - "License"); you may not use this file except in compliance
 - with the License.  You may obtain a copy of the License at
 -
 -   http://www.apache.org/licenses/LICENSE-2.0
 -
 - Unless required by applicable law or agreed to in writing,
 - software distributed under the License is distributed on an
 - "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 - KIND, either express or implied.  See the License for the
 - specific language governing permissions and limitations
 - under the License.
 -
 -->
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Exchange</title>
		<!--<link rel="stylesheet" href="/dojo/1.7.2/dojo/resources/dojo.css">
		<link rel="stylesheet" href="/dojo/1.7.2/dijit/themes/claro/claro.css">
		<link rel="stylesheet" href="/dojo/1.7.2/dojox/grid/resources/claroGrid.css">-->
        <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.7.1/dojo/resources/dojo.css">
        <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.7.1/dijit/themes/claro/claro.css">
        <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.7.1/dojox/grid/resources/claroGrid.css">

        <link rel="stylesheet" href="../css/exchange.css" media="screen">

		<link rel="stylesheet" href="css/common.css" media="screen">

        <!-- load dojo and provide config via data attribute
         style="height: 800px"-->
		<!--<script src="/dojo/1.7.2/dojo/dojo.js.uncompressed.js" data-dojo-config="async: true">
        </script>                                                                                 -->

        <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.7.1/dojo/dojo.js"
                data-dojo-config="async: true, parseOnLoad: true">
        </script>

            <script>
                require(["dijit/layout/BorderContainer", "dijit/layout/TabContainer", "dijit/layout/ContentPane",
                "dijit/TitlePane", "dojo/parser"]);
            </script>

        <script src="/js/common.js">
        </script>
        <script src="/js/exchange.js">
        </script>
        <script src="/js/sasl.js">
        </script>

        <script src="/js/header.js"></script>
        <script src="/js/footer.js"></script>
        <script src="/js/structure.js"></script>

        <script>
            require(["dojo/parser",
                     "dojox/validate/us",
                     "dojox/validate/web",
                     "dijit/form/CheckBox",
                     "dijit/form/Textarea",
                     "dijit/form/FilteringSelect",
                     "dijit/form/TextBox",
                     "dijit/form/ValidationTextBox",
                     "dijit/form/DateTextBox",
                     "dijit/form/TimeTextBox",
                     "dijit/form/Button",
                     "dijit/form/RadioButton",
                     "dijit/form/Form",
                     "dijit/form/DateTextBox",
                     "dojox/form/BusyButton",
                     "dojox/form/CheckedMultiSelect",
                     "dojo/domReady!"]);

            // Require the Dialog class
            require(["dojo/dom", "dojo/dom-construct", "dijit/registry", "dojo/_base/xhr", "dojo/store/Memory",
            "dijit/form/FilteringSelect", "dijit/Dialog","dojo/domReady!"],
                    function(dom, domConstruct, registry, xhr, Memory, FilteringSelect, Dialog)
              {

                var thisObj = this;

                createBindingDialog = function()
                {
                    var myDialog =
                        new Dialog({
                                title: "Add Binding",
                                content: "This is the dialog content.",
                                style: "width:600px;"
                                   });


                    a = "<h1>Add a new Binding</h1>"
                        + "<br/>"
                        + "<form id=\"addBindingForm\" dojoType=\"dijit.form.Form\" method=\"post\">"
                        + "</form>";
                    myDialog.set("content", a);

                    myDialog.show();
                };

                // Show the dialog
                addBindingDialog = function() {

                  if(thisObj.queueChooser)
                  {
                      thisObj.queueChooser.destroy( false );
                  }

                  var queueDiv = dom.byId("addQueuesDiv");
                  domConstruct.create("input", { id: "queueSelect" }, queueDiv);

                  var urlQuery = dojo.queryToObject(dojo.doc.location.search.substr((dojo.doc.location.search[0] === "?" ? 1 : 0)));
                  xhr.get({url: "/rest/queue/" + encodeURIComponent(urlQuery.vhost) + "?depth=0", handleAs: "json"}).then(function(data)
                    {

                      var queues =  [];
                      for(var i=0; i < data.length; i++)
                      {
                        queues[i] = {id: data[i].name, name: data[i].name};
                      }

                      var queueStore = new Memory({ data: queues });

                      thisObj.queueChooser = new FilteringSelect({ id: "queueSelect",
                                                               name: "addQueueName",
                                                               store: queueStore,
                                                               searchAttr: "name"}, "queueSelect");


                      registry.byId("addBinding").show();

                    });

                }

                // Hide the dialog
                hideAddBinding = function()
                {
                  registry.byId("addBinding").hide();
                };

                var urlQuery = dojo.queryToObject(dojo.doc.location.search.substr((dojo.doc.location.search[0] === "?" ? 1 : 0)));

                new Header("Virtual Host: "+urlQuery.vhost +"<br/>Exchange: "+urlQuery.exchange);
            });


        </script>
    </head>
	<body class="claro">


    <div id="pageLayout" data-dojo-type="dijit.layout.BorderContainer" data-dojo-props="design: 'headline', gutters: false">
        <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'top'"><div id="header" class="header"></div>
        </div>
        <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'top'">
            <div id="login"></div>
        </div>
        <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'leading', splitter: true">
            <div id="structure"></div>
        </div>
        <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'">
            <span style="">Exchange:</span><span id="name" style="position:absolute; left:6em"></span>
            <br/>
            <span style="">State:</span><span id="state" style="position:absolute; left:6em"></span>
            <br/>
            <span style="">Durable:</span><span id="durable" style="position:absolute; left:6em"></span>
            <span style="position:absolute; left:26em">Inbound:</span>
            <span id="msgInRate" style="position:absolute; right:9.5em"></span>
            <span style="position:absolute; right: 5em; width: 4em"> msg/s</span>
            <span id="bytesInRate" style="position:absolute; right: 3.3em"></span>
            <span id="bytesInRateUnits" style="position:absolute; right: 0em; width: 3em"></span>
            <br/>
            <span style="">Lifespan:</span><span style="position:absolute; left:6em" id="lifetimePolicy"></span>
            <span style="position:absolute; left:26em">Dropped:</span>
            <span id="msgDropRate" style="position:absolute; right:9.5em"></span>
            <span style="position:absolute; right: 5em; width: 4em"> msg/s</span>
            <span id="bytesDropRate" style="position:absolute; right: 3.3em"></span>
            <span id="bytesDropRateUnits" style="position:absolute; right: 0em; width: 3em"></span>
            <br/>
            <br/>
            <div data-dojo-type="dijit.TitlePane" data-dojo-props="title: 'Bindings'">
                <div id="bindings"></div>
                <button onclick="addBindingDialog();">Add Binding</button>

                <div class="dijitHidden">
                    <div data-dojo-type="dijit.Dialog" style="width:600px;" data-dojo-props="title:'Add Binding'" id="addBinding">
                        <h1>Add a new Binding</h1>
                        <br/>
                        <form id="addBindingsForm" dojoType="dijit.form.Form" method="post">
                            <script>
                                validateAndPut = function()
                                {

                                    var exchangeData = {};
                                    exchangeData.name = dojo.byId("addBindingName").value;

                                    var urlQuery = dojo.queryToObject(dojo.doc.location.search.substr((dojo.doc.location.search[0] === "?" ? 1 : 0)));
                                    var postUrl = "/rest/binding/" + encodeURIComponent(urlQuery.vhost) + "/" + encodeURIComponent(urlQuery.exchange) + "/" + encodeURIComponent(dijit.byId("queueSelect").get('value')) + "/" + encodeURIComponent(dijit.byId("addBindingName").value);


                                    dojo.xhrPut( {  url: postUrl,
                                                    handleAs: "json",
                                                    headers: { "Content-Type": "application/json"},
                                                    putData: dojo.toJson( exchangeData )}).then( function(data)
                                                        {
                                                            hideAddBinding();
                                                        },
                                                        function(error)
                                                        {
                                                            alert(error);
                                                        });
                                    return false;
                                };
                            </script>
                            <table cellpadding="0" cellspacing="2">
                                <tr>
                                    <td valign="top"><strong>Binding Key: </strong></td>
                                    <td><input type="text" required="true" name="name" id="addBindingName" placeholder="<binding-key>"
                                               dojoType="dijit.form.ValidationTextBox"/></td>
                                </tr>
                                <tr>
                                    <td valign="top"><strong>Queue: </strong></td>
                                    <td><div id="addQueuesDiv"></div>
                                    </td>
                                </tr>
                            </table>
                            <br/>
                            <input type="button" value="Submit Form" id="addBindingOk" dojoType="dojox.form.BusyButton" data-dojo-props="onClick:validateAndPut"
                                   label="Add" busyLabel="Submitting Form..." timeout="2000" />
                            <input type="button" value="Cancel" label="Cancel" id="addBindingCancel" data-dojo-props="onClick:hideAddBinding" dojoType="dijit.form.Button" />

                        </form>

                    </div>
                </div>
            </div>
            <br/>

        </div>
        <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'bottom'"><div id="footer"></div></div>
    </div>

	</body>
</html>

